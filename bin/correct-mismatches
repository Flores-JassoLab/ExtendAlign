#! /usr/bin/awk -f
#
# blastn does not align the complete sequence
# and calculates the mismatch between it's aligned region and the reference.
#
# As we are interested in knowing the real mismatch number between the whole sequence
# and the reference we need to extend the alignment and calculate the real mismatch.
#
# The `extend_alignment` is declared at `bin`
# and it's output format is described in
@include "ea_format"
#
# And the logic to count at
@include "ea_count_mismatches"
#
# In order to obtain the correct mismatch
# the extended alignment script adds columns
# containing the sequence that were added to the alignment
# in both the query and the subject:
#
#   - query_5_seq
#   - subj_5_seq
#
#   - query_3_seq
#   - subj_3_seq
#
# Each queryâ€“subject pair should match on length.
#
#
# This script fixes counts unaligned regions as mismatches
# --------------------------------------------------------
#
# Short query sequences may align to the edges of the subject_sequences
# and thus we need to consider the unaligned regions as mismatches
#
function length_if_not_na(sequence) {
#        -----------------
#
# The alignment cannot be extended outside the bounds of the subject sequence,
# in the case where the alignment exceeds or stops at those bounds,
# `extend_alignment` adds the special value NA as defined in `ea_format`.
#
	return (sequence == NA) ? 0 : length(sequence)
}
{
#
# The region accounted by our pipeline so far is
  accounted_length = $alignment_length + length_if_not_na($query_5_seq) + length_if_not_na($query_3_seq)
#
# That length should be equal or less than the query_length
  if(accounted_length > $query_length) {
# we should report the following
  print $0, "error:" NR ": accounted_length is greater than input sequence length"
  }
#
# We calculate the mismatch in the extended regions
$extended_mismatch = count_mismatches($query_3_seq, $subj_3_seq) + \
	count_mismatches($query_5_seq, $subj_5_seq)
#
# The length of the query sequence that exceeds the bounds of subject sequence
# should be added to the
 $total_mismatch = $mismatch + $gapopen + $extended_mismatch + ($query_length - accounted_length)
#
# Finally, we should
  print $0
# our result.
}
