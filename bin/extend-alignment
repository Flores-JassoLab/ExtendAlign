#!/usr/bin/awk -f
#
# The output file is described at
@include "ea_format.awk"
#
FNR == 1 && f < 2 {
	f++
	if (f == 1) {
		query_fasta = FILENAME
		nextfile
	}
	if (f == 2) {
		subj_fasta = FILENAME
		nextfile
	}
}
# Query Sequences
# ===============
#
# As we have the complete query sequence, we can just get the missing substrings
#
function get_5_ext(seq) {
	_seq = substr(seq, 1, len_5_ext)
	return _seq ? _seq : NA
}
function get_3_ext(seq) {
	_seq = substr(seq, ($query_end + 1), len_3_ext)
	return _seq ? _seq : NA
}
function get_complete_seq(reference, name, start, end) {
#        ================
#
#
# The commands for interrogating is
  program = "seq-from-indexed-fasta "
#
#
	if ($strand == "minus") {
		_pos = name ":" (start + len_5_ext) "-" (end - len_3_ext)
		cmd = program reference " " _pos
		cmd | getline _seq
	} else {
		_pos = name ":" (start - len_5_ext) "-" (end + len_3_ext)
		cmd = program reference " " _pos " | dna-reverse-complement"
		cmd | getline _seq
	}
	close(cmd)
	return _seq ? _seq : NA
}
#
# MAIN
# ====
#
{
	len_5_ext = ($query_start - 1)
	len_3_ext = ($query_length - $query_end)
#
	$complete_query_seq = get_complete_seq(query_fasta, $query_name, $query_start, $query_end)
	$complete_subj_seq = get_complete_seq(subj_fasta, $subj_name, $subj_start, $subj_end)
#
	$query_5_seq = get_5_ext($complete_query_seq)
	$query_3_seq = get_3_ext($complete_query_seq)
	$subj_5_seq = get_5_ext($complete_subj_seq)
	$subj_3_seq = get_3_ext($complete_subj_seq)
#
	unset len_5_ext
	unset len_3_ext
#
	print $0
}
