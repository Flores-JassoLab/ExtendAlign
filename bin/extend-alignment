#!/usr/bin/awk -f
# The output file is described at
@include "ea_format.awk"
#
# Extension is different for each strandness.
#
# Query Sequences
# ===============
#
# As we have the complete query sequence, we can just get the missing substrings
#
function get_5_ext(seq) {
	_seq = substr(seq, 1, len_5_ext)
	return _seq ? _seq : NA
}
function get_3_ext(seq) {
	_seq = substr(seq, ($query_end + 1), len_3_ext)
	return _seq ? _seq : NA
}
function get_complete_seq(reference, name, start, end) {
#        ================
#
#
# The commands for interrogating is
  program = "seq-from-indexed-fasta "
#
#
# We assume the majority of the sequences are plus
# even if not declared.
#
	if ($strand == "minus") {
		_pos = name ":" (start + len_5_ext) "-" (end - len_3_ext)
		cmd = program reference " " _pos
		cmd | getline _seq
	} else {
		_pos = name ":" (start - len_5_ext) "-" (end + len_3_ext)
		cmd = program reference " " _pos " | dna-reverse-complement"
		cmd | getline _seq
	}
	close(cmd)
	return _seq ? _seq : NA
}
#
# MAIN
# ====
#
{
	len_5_ext = ($query_start - 1)
	len_3_ext = ($query_length - $query_end)
#
	$complete_query_seq = get_complete_seq("/labs/crve-fabian/mirna_vaca/miRNAs-mismatches/ExtendAlign/EA-long-seqs/001-blastn/data/hsa-miRNAs22.fa", $query_name, $query_start, $query_end)
	$complete_subj_seq = get_complete_seq("${REFERENCE}", $subj_name, $subj_start, $subj_end)
#
	$query_5_seq = get_5_ext($complete_query_seq)
	$query_3_seq = get_3_ext($complete_query_seq)
	$subj_5_seq = get_5_ext($complete_subj_seq)
	$subj_3_seq = get_3_ext($complete_subj_seq)
#
	print $0
}
